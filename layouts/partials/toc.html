<div class="article-toc lg:block hidden fixed top-20" style="right: max(1rem, calc((100% - 1500px) / 2));">
  <div class="w-[320px] bg-white dark:bg-neutral-800 rounded-xl shadow-lg">
    <!-- 目录标题 -->
    <div class="px-4 py-3 bg-neutral-50 dark:bg-neutral-700">
      <h3 class="text-lg font-semibold text-neutral-800 dark:text-neutral-100">
        {{ i18n "article.table_of_contents" | default "Table of Contents" }}
      </h3>
    </div>
    
    <!-- 目录内容 -->
    <div id="toc-wrapper" class="p-4 max-h-[70vh] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-400 scrollbar-track-gray-100 dark:scrollbar-thumb-gray-600 dark:scrollbar-track-gray-800">
      <div id="toc-content">
        {{ .TableOfContents | emojify }}
      </div>
    </div>
  </div>
</div>

<!-- 移动端目录 -->
<details class="toc-mobile lg:hidden mt-4 mb-8">
  <summary class="px-4 py-2 bg-neutral-50 dark:bg-neutral-700 rounded-lg cursor-pointer">
    <span class="text-lg font-semibold text-neutral-800 dark:text-neutral-100">
      {{ i18n "article.table_of_contents" | default "Table of Contents" }}
    </span>
  </summary>
  <div class="px-4 py-3 mt-2 bg-white dark:bg-neutral-800 rounded-lg shadow">
    {{ .TableOfContents | emojify }}
  </div>
</details>

<style>
/* 基础目录样式 */
#TableOfContents {
  width: 100%;
}

#TableOfContents ul {
  list-style: none;
  margin: 0;
  padding: 0;
}

#TableOfContents ul ul {
  padding-left: 1.25rem;
}

#TableOfContents a {
  display: block;
  padding: 0.4rem 0.75rem;
  margin: 0.25rem 0;
  color: #6B7280;
  font-size: 0.875rem;
  line-height: 1.4;
  text-decoration: none;
  border-radius: 0.375rem;
  transition: all 0.2s;
}

/* 激活状态样式 */
#TableOfContents a.toc-active {
  color: #1D4ED8;
  background-color: #EEF2FF;
  border-bottom: 2px solid #1D4ED8;
  font-weight: 500;
}

/* 暗色模式样式 */
.dark #TableOfContents a {
  color: #9CA3AF;
}

.dark #TableOfContents a.toc-active {
  color: #93C5FD;
  background-color: #374151;
  border-bottom: 2px solid #93C5FD;
}

#toc-wrapper {
  width: 280px; /* 减小固定宽度 */
}

#TableOfContents a:hover {
  background-color: rgb(243 244 246);
}

.dark #TableOfContents a:hover {
  background-color: rgb(55 65 81);
}

/* 设置滚动条样式 */
#toc-wrapper::-webkit-scrollbar {
  width: 6px;
}

#toc-wrapper::-webkit-scrollbar-track {
  background-color: rgb(243 244 246);
  border-radius: 3px;
}

#toc-wrapper::-webkit-scrollbar-thumb {
  background-color: rgb(156 163 175);
  border-radius: 3px;
}

.dark #toc-wrapper::-webkit-scrollbar-track {
  background-color: rgb(31 41 55);
}

.dark #toc-wrapper::-webkit-scrollbar-thumb {
  background-color: rgb(75 85 99);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // 强制设置目录宽度
  const tocContent = document.querySelector('#toc-content');
  if (tocContent) {
    const links = tocContent.getElementsByTagName('a');
    for (let link of links) {
      link.style.width = '100%';
      link.style.whiteSpace = 'normal';
      link.style.wordBreak = 'break-word';
    }
  }

  // 添加滚动监听来控制目录显示
  const toc = document.querySelector('.article-toc');
  const comments = document.querySelector('.comments-container, #comments, footer'); // 匹配可能的评论区选择器
  
  if (toc && comments) {
    window.addEventListener('scroll', function() {
      const commentsRect = comments.getBoundingClientRect();
      // 当评论区进入视口时
      if (commentsRect.top <= window.innerHeight) {
        toc.style.opacity = '0';
        toc.style.visibility = 'hidden';
        toc.style.transition = 'opacity 0.3s, visibility 0.3s';
      } else {
        toc.style.opacity = '1';
        toc.style.visibility = 'visible';
      }
    });
  }

  // 简化的滚动监听
  const tocLinks = document.querySelectorAll('#TableOfContents a');
  const sections = Array.from(document.querySelectorAll('h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]'));
  
  function updateToc() {
    const top = window.scrollY;
    const found = sections.find(section => {
      const offset = section.offsetTop - 100;
      return offset > top && offset < top + 100;
    }) || sections[0];

    tocLinks.forEach(link => {
      if (found && link.getAttribute('href') === `#${found.id}`) {
        link.classList.add('toc-active');
      } else {
        link.classList.remove('toc-active');
      }
    });
  }

  // 使用防抖优化滚动性能
  let scrollTimeout;
  window.addEventListener('scroll', () => {
    if (scrollTimeout) {
      window.cancelAnimationFrame(scrollTimeout);
    }
    scrollTimeout = window.requestAnimationFrame(updateToc);
  });

  // 初始化
  updateToc();
});

  var margin = 200;
  var marginError = 50;

  (function () {
    var $window = $(window);
    var $toc = $('#TOCView');
    var tocHeight = $toc.height();

    function onResize() {
      var windowAndMarginHeight = $window.height() - margin;
      if(tocHeight >= windowAndMarginHeight) {
        $toc.css("overflow-y", "scroll")
        $toc.css("max-height", (windowAndMarginHeight + marginError) + "px")
      } else {
        $toc.css("overflow-y", "hidden")
        $toc.css("max-height", "9999999px")
      }
    }

    $window.on('resize', onResize);
    $(document).ready(onResize);
  })();

{{ if .Site.Params.smartTOC }}

  (function () {
    var $toc = $('#TableOfContents');
    if ($toc.length > 0) {
      var $window = $(window);

      function onScroll() {
        var currentScroll = $window.scrollTop();
        var h = $('.anchor');
        var id = "";
        h.each(function (i, e) {
          e = $(e);
          if (e.offset().top - $(window).height()/3 <= currentScroll) {
            id = decodeURIComponent(e.attr('id'));
          }
        });
        var active = $toc.find('a.active');      
        if (active.length == 1 && active.eq(0).attr('href') == '#' + id) return true;

        active.each(function (i, e) {
          {{ if .Site.Params.smartTOCHideUnfocusedChildren }} 
            $(e).removeClass('active').siblings('ul').hide();
          {{ else }}
            $(e).removeClass('active');
          {{ end }}
        });
        $toc.find('a[href="#' + id + '"]').addClass('active')
        $toc.find('a[href="#' + id + '"]').parentsUntil('#TableOfContents').each(function (i, e) {
          $(e).children('a').parents('ul').show();          
        });
      }

      $window.on('scroll', onScroll);
      $(document).ready(function () {
        {{ if .Site.Params.smartTOCHideUnfocusedChildren }} 
          $toc.find('a').parent('li').find('ul').hide();
        {{ end }}
        onScroll();
      });
    }
  })();
{{ end }}

</script>
